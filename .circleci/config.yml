version: 2

executors:
  depper:

jobs:
  deploy:
    docker:
      - image: circleci/golang:1.15

    working_directory: /go/src/github.com/{{ORG_NAME}}/{{REPO_NAME}}

    steps:
      - checkout

      - run:
          name: Setup gcp account credentials
          command: echo $GCP_SERVICE_ACCOUNT_JSON | base64 -d > ~/.gcp_service_account.json


      - run:
          name: Install Docker client
          command: |
            set -x
            VER="18.06.3-ce"
            curl -L -o /tmp/docker-$VER.tgz https://download.docker.com/linux/static/stable/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      - checkout:
          path: depper

      - run:
          name: Clone deployment project
          command: |
            echo "StrictHostKeyChecking no" >> ~/.ssh/config
            git clone git@github.com:tidelift/deploy

      - setup_remote_docker

      - run:
          name: Build image
          working_directory: depper
          command: ~/deploy/tl-deploy-circleci build_image

      - run:
          name: Upload image
          working_directory: depper
          command: ~/deploy/tl-deploy-circleci upload_image

      - run:
          name: Tag latest
          working_directory: depper
          command: ~/deploy/tl-deploy-circleci tag_latest

      - run:
          name: Deploy worker
          working_directory: depper
          command: ~/deploy/tl-deploy-circleci rollout libraries-depper

workflows:
  version: 2
  circleci_build:
    jobs:
      - deploy
